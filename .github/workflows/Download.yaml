name: Download MOPS PDFs

# Add necessary permissions for release creation
permissions:
  contents: write
  actions: read

on:
  # Manual trigger with year and quarter parameters
  workflow_dispatch:
    inputs:
      year:
        description: 'Year to download (e.g., 2025)'
        required: true
        type: string
        default: '2025'
      quarter:
        description: 'Quarter to download (1, 2, 3, or 4)'
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
        default: '1'
      delay:
        description: 'Delay between downloads (seconds)'
        required: false
        type: string
        default: '10.0'
      start_from:
        description: 'Start from specific company ID (optional)'
        required: false
        type: string
        default: '2412'
      only_missing_files:
        description: 'Skip files that already exist locally (size > 100KB)'
        required: false
        type: boolean
        default: true
      upload_to_sheets:
        description: 'Upload matrix to Google Sheets after download'
        required: false
        type: boolean
        default: true
  
  # Scheduled trigger - runs quarterly on the 15th day of each quarter
  schedule:
    # Run at 02:00 UTC on the 15th day of January, April, July, October
    - cron: '0 2 15 1,4,7,10 *'

env:
  # Google Sheets credentials (add these to your repository secrets)
  GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
  GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

jobs:
  download-pdfs:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours timeout
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git
        # Set up environment for Unicode support
        export PYTHONIOENCODING=utf-8
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Install required dependencies for mops_downloader
        pip install -r requirements.txt
        
        # Install the package in development mode (since it's in the same repo)
        # This will make the mops_downloader package importable
        pip install -e .
        
        # Install any additional requirements if they exist
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: Verify installation and dependencies
      run: |
        # Verify mops_downloader can be imported
        python -c "import mops_downloader; print('‚úÖ mops_downloader package imported successfully')"
        
        # Test CLI script (with basic help check)
        python scripts/mops_downloader.py --help || echo "CLI script check completed"
        
        # Verify main components
        python -c "from mops_downloader.main import MOPSDownloader; print('‚úÖ MOPSDownloader class imported successfully')"
        
        # Verify sheets uploader dependencies
        python -c "import pandas; print('‚úÖ pandas imported successfully')"
        python -c "import gspread; print('‚úÖ gspread imported successfully')" || echo "‚ö†Ô∏è gspread not available - sheets upload will be skipped"
    
    - name: Verify CSV file exists
      run: |
        if [ ! -f "StockID_TWSE_TPEX.csv" ]; then
          echo "Error: StockID_TWSE_TPEX.csv not found!"
          echo "Available files:"
          ls -la *.csv || echo "No CSV files found"
          exit 1
        fi
        echo "‚úÖ CSV file found with $(wc -l < StockID_TWSE_TPEX.csv) lines"
    
    - name: Set up Git configuration
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Create downloads and logs directories
      run: |
        mkdir -p downloads
        mkdir -p logs
        echo "‚úÖ Created downloads and logs directories"
    
    - name: Download PDFs (Manual Trigger)
      if: github.event_name == 'workflow_dispatch'
      run: |
        # Set environment for Unicode support
        export PYTHONIOENCODING=utf-8
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        
        echo "üöÄ Starting manual MOPS download..."
        echo "Year: ${{ inputs.year }}"
        echo "Quarter: ${{ inputs.quarter }}"
        echo "Delay: ${{ inputs.delay }}"
        echo "Start From: ${{ inputs.start_from || 'Beginning' }}"
        echo "Only Missing Files: ${{ inputs.only_missing_files }}"
        echo "Upload to Sheets: ${{ inputs.upload_to_sheets }}"
        
        # Show skip behavior info
        if [ "${{ inputs.only_missing_files }}" == "true" ]; then
          echo "üìÅ Skip mode enabled: Will skip existing files > 100KB"
        else
          echo "üîÑ Force download mode: Will re-download all files even if they exist"
        fi
        
        # Build command arguments for DownloadAll.py (based on actual CLI interface)
        CMD_ARGS=""
        CMD_ARGS="$CMD_ARGS --year ${{ inputs.year }}"
        CMD_ARGS="$CMD_ARGS --quarter ${{ inputs.quarter }}"
        CMD_ARGS="$CMD_ARGS --delay ${{ inputs.delay }}"
        
        # Add start-from if provided (note: hyphen, not underscore)
        if [ -n "${{ inputs.start_from }}" ]; then
          CMD_ARGS="$CMD_ARGS --start-from ${{ inputs.start_from }}"
        fi
        
        # Add only-missing-files if enabled
        if [ "${{ inputs.only_missing_files }}" == "true" ]; then
          CMD_ARGS="$CMD_ARGS --only-missing-files"
        fi
        
        echo "Running: python DownloadAll.py $CMD_ARGS"
        python DownloadAll.py $CMD_ARGS || {
          echo "‚ùå DownloadAll.py failed, trying alternative approach..."
          
          # Fallback: Use individual CLI calls for a few companies as test
          echo "Testing individual downloads..."
          
          # Build CLI args for fallback
          CLI_ARGS="--year ${{ inputs.year }} --quarter ${{ inputs.quarter }} --log_level INFO"
          if [ "${{ inputs.only_missing_files }}" == "true" ]; then
            CLI_ARGS="$CLI_ARGS --only-missing-files"
            echo "üìÅ Fallback using skip mode: Will skip existing files > 100KB"
          else
            echo "üîÑ Fallback using force download mode"
          fi
          
          head -5 StockID_TWSE_TPEX.csv | tail -n +2 | while IFS=, read -r company_id company_name exchange || [ -n "$company_id" ]; do
            if [ -n "$company_id" ]; then
              echo "Testing download for company: $company_id"
              python scripts/mops_downloader.py --company_id "$company_id" $CLI_ARGS || echo "Failed for company $company_id"
            fi
          done
        }
    
    - name: Download PDFs (Scheduled Trigger)
      if: github.event_name == 'schedule'
      run: |
        # Set environment for Unicode support
        export PYTHONIOENCODING=utf-8
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        
        # Determine current quarter based on month
        MONTH=$(date +%m)
        if [ "$MONTH" -eq 1 ]; then
          QUARTER=1
          YEAR=$(date +%Y)
        elif [ "$MONTH" -eq 4 ]; then
          QUARTER=2
          YEAR=$(date +%Y)
        elif [ "$MONTH" -eq 7 ]; then
          QUARTER=3
          YEAR=$(date +%Y)
        elif [ "$MONTH" -eq 10 ]; then
          QUARTER=4
          YEAR=$(date +%Y)
        else
          # Fallback to previous quarter
          QUARTER=1
          YEAR=$(date +%Y)
        fi
        
        echo "üöÄ Scheduled MOPS download: Year=$YEAR, Quarter=$QUARTER"
        echo "üìÅ Scheduled runs use skip mode by default (only download missing files)"
        echo "üìä Scheduled runs automatically upload to Google Sheets"
        
        # Scheduled runs default to only-missing-files to avoid redundant downloads
        python DownloadAll.py --year $YEAR --quarter $QUARTER --delay 3.0 --only-missing-files
    
    - name: Check download results
      run: |
        echo "=== Download Summary ==="
        echo "Current directory contents:"
        ls -la
        
        echo -e "\n=== Downloads directory structure ==="
        if [ -d "downloads" ]; then
          find downloads -type f -name "*.pdf" | head -20
          echo -e "\nTotal PDF files found in downloads/:"
          find downloads -type f -name "*.pdf" | wc -l
          
          echo -e "\nCompany directories:"
          find downloads -type d -mindepth 1 | head -10
          
          echo -e "\nSample files per company:"
          find downloads -type d -mindepth 1 | head -5 | while read dir; do
            company=$(basename "$dir")
            count=$(find "$dir" -name "*.pdf" | wc -l)
            echo "  $company: $count PDF files"
            find "$dir" -name "*.pdf" | head -2 | sed 's/^/    /'
          done
        else
          echo "‚ùå No downloads directory found"
        fi
        
        echo -e "\n=== Logs directory ==="
        if [ -d "logs" ]; then
          ls -la logs/
          echo -e "\nLatest log file (last 20 lines):"
          find logs -name "*.log" -type f -exec tail -20 {} \; | tail -20
        else
          echo "‚ùå No logs directory found"
        fi
        
        echo -e "\n=== Disk usage ==="
        du -sh . 2>/dev/null || echo "Could not calculate disk usage"
        du -sh downloads/ 2>/dev/null || echo "Could not calculate downloads disk usage"

    - name: Upload matrix to Google Sheets
      # ‚úÖ This works for both manual and scheduled runs
      if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.upload_to_sheets == true))
      run: |
        echo "üìä Starting MOPS Sheets Uploader..."
        
        # Set environment for Unicode support
        export PYTHONIOENCODING=utf-8
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        
        # Check if required environment variables are available
        if [ -z "$GOOGLE_SHEETS_CREDENTIALS" ] || [ -z "$GOOGLE_SHEET_ID" ]; then
          echo "‚ö†Ô∏è Google Sheets credentials not configured"
          echo "   GOOGLE_SHEETS_CREDENTIALS: ${GOOGLE_SHEETS_CREDENTIALS:+SET}"
          echo "   GOOGLE_SHEET_ID: ${GOOGLE_SHEET_ID:+SET}"
          echo "   Skipping Google Sheets upload, will generate CSV backup only"
          
          # Run in CSV-only mode
          python scripts/sheets_uploader.py --csv-only --output data/mops_matrix_$(date +%Y%m%d_%H%M%S).csv || {
            echo "‚ùå CSV-only upload failed, trying manual matrix generation..."
            
            # Fallback: Create a simple summary manually
            echo "Creating manual download summary..."
            SUMMARY_FILE="matrix_summary_$(date +%Y%m%d_%H%M%S).csv"
            echo "‰ª£Ëôü,ÂêçÁ®±,Á∏ΩÂ†±ÂëäÊï∏,ÊúÄÊñ∞Â≠£Â∫¶" > "$SUMMARY_FILE"
            
            if [ -d "downloads" ]; then
              find downloads -type d -mindepth 1 | while read dir; do
                company=$(basename "$dir")
                count=$(find "$dir" -name "*.pdf" | wc -l)
                latest=$(find "$dir" -name "*.pdf" | sort | tail -1 | xargs basename 2>/dev/null || echo "ÁÑ°")
                echo "$company,ÂæÖÊü•Ë©¢,$count,$latest" >> "$SUMMARY_FILE"
              done
            fi
            
            echo "‚úÖ Manual summary created: $SUMMARY_FILE"
          }
        else
          echo "‚úÖ Google Sheets credentials configured"
          echo "üìä Uploading matrix to Google Sheets..."
          
          # Try to upload to Google Sheets with CSV fallback
          python scripts/sheets_uploader.py --upload || {
            echo "‚ö†Ô∏è Google Sheets upload failed, falling back to CSV only..."
            python scripts/sheets_uploader.py --csv-only --output data/mops_matrix_$(date +%Y%m%d_%H%M%S).csv || {
              echo "‚ùå CSV fallback also failed"
              exit 0  # Don't fail the whole workflow
            }
          }
        fi
        
        echo "‚úÖ Sheets uploader process completed"

    - name: Verify sheets upload results
      # ‚úÖ This works for both manual and scheduled runs
      if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.upload_to_sheets == true))
      run: |
        echo "=== Sheets Upload Verification ==="
        
        # Check for CSV output files
        if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
          echo "‚úÖ CSV backup files found:"
          ls -la data/mops_matrix_*.csv
          
          echo -e "\nCSV file preview (first 10 lines):"
          head -10 data/mops_matrix_*.csv | head -10
        else
          echo "‚ùå No CSV backup files found"
        fi
        
        # Check for sheets uploader logs
        if ls logs/*sheets* 1> /dev/null 2>&1; then
          echo -e "\nüìä Sheets uploader logs:"
          ls -la logs/*sheets*
          
          echo -e "\nLatest sheets log (last 10 lines):"
          find logs -name "*sheets*" -type f -exec tail -10 {} \; | tail -10
        else
          echo "üìä No specific sheets uploader logs found"
        fi
        
        # Generate upload status report
        UPLOAD_STATUS_FILE="sheets_upload_status.txt"
        echo "Google Sheets Upload Status Report" > "$UPLOAD_STATUS_FILE"
        echo "Date: $(date)" >> "$UPLOAD_STATUS_FILE"
        echo "Trigger: ${{ github.event_name }}" >> "$UPLOAD_STATUS_FILE"
        echo "=================" >> "$UPLOAD_STATUS_FILE"
        
        if [ -n "$GOOGLE_SHEETS_CREDENTIALS" ] && [ -n "$GOOGLE_SHEET_ID" ]; then
          echo "‚úÖ Credentials: Available" >> "$UPLOAD_STATUS_FILE"
          echo "üìä Sheet ID: ${GOOGLE_SHEET_ID}" >> "$UPLOAD_STATUS_FILE"
        else
          echo "‚ùå Credentials: Not configured" >> "$UPLOAD_STATUS_FILE"
        fi
        
        if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
          CSV_COUNT=$(ls data/mops_matrix_*.csv | wc -l)
          echo "‚úÖ CSV backups: $CSV_COUNT files created" >> "$UPLOAD_STATUS_FILE"
        else
          echo "‚ùå CSV backups: No files found" >> "$UPLOAD_STATUS_FILE"
        fi
        
        if [ -d "downloads" ]; then
          PDF_COUNT=$(find downloads -name "*.pdf" -type f | wc -l)
          COMPANY_COUNT=$(find downloads -type d -mindepth 1 | wc -l)
          echo "üìÅ Source data: $PDF_COUNT PDFs from $COMPANY_COUNT companies" >> "$UPLOAD_STATUS_FILE"
        else
          echo "‚ùå Source data: No downloads directory found" >> "$UPLOAD_STATUS_FILE"
        fi
        
        echo "‚úÖ Upload status report created: $UPLOAD_STATUS_FILE"
    
    - name: Organize downloaded files (if needed)
      run: |
        # The mops_downloader uses flattened structure: downloads/{company_id}/*.pdf
        # No additional organization needed, but we can create a summary
        
        YEAR="${{ inputs.year || '2025' }}"
        QUARTER="${{ inputs.quarter || '1' }}"
        ONLY_MISSING="${{ inputs.only_missing_files || 'true' }}"
        UPLOAD_SHEETS="${{ inputs.upload_to_sheets || 'true' }}"
        
        if [ "${{ github.event_name }}" == "schedule" ]; then
          MONTH=$(date +%m)
          if [ "$MONTH" -eq 1 ]; then
            QUARTER=1
            YEAR=$(date +%Y)
          elif [ "$MONTH" -eq 4 ]; then
            QUARTER=2
            YEAR=$(date +%Y)
          elif [ "$MONTH" -eq 7 ]; then
            QUARTER=3
            YEAR=$(date +%Y)
          elif [ "$MONTH" -eq 10 ]; then
            QUARTER=4
            YEAR=$(date +%Y)
          fi
          ONLY_MISSING="true"  # Scheduled runs always use skip mode
          UPLOAD_SHEETS="true" # Scheduled runs always upload to sheets
        fi
        
        # Create a comprehensive summary file
        SUMMARY_FILE="download_summary_${YEAR}_Q${QUARTER}.txt"
        echo "MOPS Download Summary" > "$SUMMARY_FILE"
        echo "Year: $YEAR, Quarter: $QUARTER" >> "$SUMMARY_FILE"
        echo "Download Date: $(date)" >> "$SUMMARY_FILE"
        echo "Skip Existing Files: $ONLY_MISSING" >> "$SUMMARY_FILE"
        echo "Upload to Sheets: $UPLOAD_SHEETS" >> "$SUMMARY_FILE"
        echo "=================" >> "$SUMMARY_FILE"
        
        if [ -d "downloads" ]; then
          echo "Companies processed:" >> "$SUMMARY_FILE"
          find downloads -type d -mindepth 1 | while read dir; do
            company=$(basename "$dir")
            count=$(find "$dir" -name "*.pdf" | wc -l)
            echo "  $company: $count PDF files" >> "$SUMMARY_FILE"
          done
          
          total_files=$(find downloads -name "*.pdf" | wc -l)
          total_companies=$(find downloads -type d -mindepth 1 | wc -l)
          echo "" >> "$SUMMARY_FILE"
          echo "Total: $total_files PDF files from $total_companies companies" >> "$SUMMARY_FILE"
        fi
        
        # Add sheets upload status to summary
        echo "" >> "$SUMMARY_FILE"
        echo "Google Sheets Upload:" >> "$SUMMARY_FILE"
        if [ "$UPLOAD_SHEETS" == "true" ]; then
          if [ -n "$GOOGLE_SHEETS_CREDENTIALS" ]; then
            echo "  Status: Attempted (check logs for results)" >> "$SUMMARY_FILE"
          else
            echo "  Status: Skipped (credentials not configured)" >> "$SUMMARY_FILE"
          fi
        else
          echo "  Status: Disabled by user" >> "$SUMMARY_FILE"
        fi
        
        if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
          CSV_COUNT=$(ls data/mops_matrix_*.csv | wc -l)
          echo "  CSV Backup: $CSV_COUNT files created" >> "$SUMMARY_FILE"
        else
          echo "  CSV Backup: No files found" >> "$SUMMARY_FILE"
        fi
        
        echo "‚úÖ Created download summary: $SUMMARY_FILE"
    
    - name: Commit downloaded MOPS files
      if: success()
      run: |
        echo "Committing downloaded MOPS files..."
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Add downloaded files and logs (exclude cache or temporary files)
        git add downloads/*.pdf downloads/*/metadata.json || true
        git add logs/*.log || true
        git add download_summary_*.txt || true
        git add status_report.md || true
        git add sheets_upload_status.txt || true
        git add data/reports/mops_matrix_*.csv || true  # Add CSV matrix files
        
        if git diff --staged --quiet; then
          echo "No MOPS download changes to commit"
        else
          # Determine commit message based on trigger type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.only_missing_files }}" == "true" ]; then
              COMMIT_MSG="üìÅ MOPS PDFs Download (Skip Mode) - ${{ inputs.year }} Q${{ inputs.quarter }}"
            else
              COMMIT_MSG="üîÑ MOPS PDFs Download (Force Mode) - ${{ inputs.year }} Q${{ inputs.quarter }}"
            fi
            
            # Add sheets upload info to commit message
            if [ "${{ inputs.upload_to_sheets }}" == "true" ]; then
              COMMIT_MSG="${COMMIT_MSG} + üìä Matrix Upload"
            fi
          else
            YEAR=$(date +%Y)
            MONTH=$(date +%m)
            if [ "$MONTH" -eq 1 ]; then QUARTER=1
            elif [ "$MONTH" -eq 4 ]; then QUARTER=2
            elif [ "$MONTH" -eq 7 ]; then QUARTER=3
            elif [ "$MONTH" -eq 10 ]; then QUARTER=4
            else QUARTER=1; fi
            COMMIT_MSG="üìÅ Scheduled MOPS Download + üìä Matrix Upload - ${YEAR} Q${QUARTER}"
          fi
          
          # Count downloaded files for commit message
          if [ -d "downloads" ]; then
            PDF_COUNT=$(find downloads -name "*.pdf" -type f | wc -l)
            COMPANY_COUNT=$(find downloads -type d -mindepth 1 | wc -l)
            if [ "$PDF_COUNT" -gt 0 ]; then
              COMMIT_MSG="${COMMIT_MSG} (${PDF_COUNT} files from ${COMPANY_COUNT} companies)"
            else
              COMMIT_MSG="${COMMIT_MSG} (no PDFs downloaded)"
            fi
            
            # Add matrix info if CSV files exist
            if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
              CSV_COUNT=$(ls data/mops_matrix_*.csv | wc -l)
              COMMIT_MSG="${COMMIT_MSG} + Matrix CSV (${CSV_COUNT} files)"
            fi
          else
            COMMIT_MSG="${COMMIT_MSG} (no downloads directory)"
          fi
          
          COMMIT_MSG="${COMMIT_MSG} - $(date +%Y-%m-%d\ %H:%M:%S)"
          
          git commit -m "$COMMIT_MSG" || true
          git push || true
          echo "‚úÖ MOPS download results committed successfully"
        fi
    
    - name: Create release (for manual runs)
      if: github.event_name == 'workflow_dispatch' && success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create release using GitHub CLI (more reliable than actions/create-release@v1)
        RELEASE_TAG="mops-${{ inputs.year }}-q${{ inputs.quarter }}-$(date +%Y%m%d-%H%M%S)"
        RELEASE_TITLE="MOPS PDFs ${{ inputs.year }} Q${{ inputs.quarter }}"
        
        # Count files for release description
        if [ -d "downloads" ]; then
          PDF_COUNT=$(find downloads -name "*.pdf" -type f | wc -l)
          COMPANY_COUNT=$(find downloads -type d -mindepth 1 | wc -l)
          RESULTS_TEXT="- ‚úÖ $PDF_COUNT PDF files downloaded from $COMPANY_COUNT companies"
        else
          RESULTS_TEXT="- ‚ùå No downloads found"
        fi
        
        # Check matrix upload results
        MATRIX_RESULTS=""
        if [ "${{ inputs.upload_to_sheets }}" == "true" ]; then
          if [ -n "$GOOGLE_SHEETS_CREDENTIALS" ]; then
            MATRIX_RESULTS="- üìä Matrix uploaded to Google Sheets (check logs for status)"
          else
            MATRIX_RESULTS="- ‚ö†Ô∏è Matrix upload skipped (credentials not configured)"
          fi
          
          if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
            CSV_COUNT=$(ls data/mops_matrix_*.csv | wc -l)
            MATRIX_RESULTS="${MATRIX_RESULTS}\n- üíæ CSV backup: $CSV_COUNT files created"
          fi
        else
          MATRIX_RESULTS="- üìä Matrix upload disabled by user"
        fi
        
        # Create release body
        cat > release_body.md << EOF
        Downloaded MOPS PDFs for ${{ inputs.year }} Q${{ inputs.quarter }}
        
        **Download Parameters:**
        - Year: ${{ inputs.year }}
        - Quarter: ${{ inputs.quarter }}
        - Delay: ${{ inputs.delay }}s
        - Start from: ${{ inputs.start_from || 'Beginning' }}
        - Skip existing files: ${{ inputs.only_missing_files }}
        - Upload to sheets: ${{ inputs.upload_to_sheets }}
        
        **Results:**
        $RESULTS_TEXT
        $MATRIX_RESULTS
        - Check the downloads/ directory for PDF files organized by company ID
        - Each company has its own subdirectory with flattened structure
        - Log files available in logs/ directory
        - Matrix CSV files available in data/ directory
        
        **File Structure:**
        \`\`\`
        downloads/
        ‚îú‚îÄ‚îÄ {company_id}/
        ‚îÇ   ‚îú‚îÄ‚îÄ YYYYQQ_{company_id}_AXX.pdf
        ‚îÇ   ‚îî‚îÄ‚îÄ metadata.json
        ‚îú‚îÄ‚îÄ data/
        ‚îÇ   ‚îî‚îÄ‚îÄ mops_matrix_{timestamp}.csv
        ‚îî‚îÄ‚îÄ logs/
            ‚îî‚îÄ‚îÄ mops_downloader_{timestamp}.log
        \`\`\`
        
        **Google Sheets Integration:**
        - Matrix view available in Google Sheets (if credentials configured)
        - Worksheet: "MOPS‰∏ãËºâÁãÄÊÖã"
        - CSV backup always generated for offline access
        EOF
        
        # Try to create release using GitHub CLI
        if command -v gh &> /dev/null; then
          echo "Creating release using GitHub CLI..."
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_TITLE" \
            --notes-file release_body.md \
            --draft=false \
            --prerelease=false || echo "Failed to create release with gh CLI"
        else
          echo "GitHub CLI not available, creating simple tag..."
          git tag "$RELEASE_TAG"
          git push origin "$RELEASE_TAG" || echo "Failed to push tag"
        fi
    
    # Upload artifacts for manual download
    - name: Upload PDF artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mops-pdfs-${{ inputs.year || 'scheduled' }}-q${{ inputs.quarter || 'auto' }}
        path: |
          downloads/
          logs/
          data/
          download_summary_*.txt
          sheets_upload_status.txt
        retention-days: 30
        if-no-files-found: warn
    
    # Optional: Create a status report
    - name: Create status report
      if: always()
      run: |
        echo "=== MOPS Download Status Report ===" > status_report.md
        echo "**Workflow:** ${{ github.workflow }}" >> status_report.md
        echo "**Trigger:** ${{ github.event_name }}" >> status_report.md
        echo "**Date:** $(date)" >> status_report.md
        echo "" >> status_report.md
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "**Parameters:**" >> status_report.md
          echo "- Year: ${{ inputs.year }}" >> status_report.md
          echo "- Quarter: ${{ inputs.quarter }}" >> status_report.md
          echo "- Delay: ${{ inputs.delay }}s" >> status_report.md
          echo "- Start From: ${{ inputs.start_from || 'Beginning' }}" >> status_report.md
          echo "- Skip Existing Files: ${{ inputs.upload_to_sheets }}" >> status_report.md
          echo "- Upload to Sheets: ${{ inputs.upload_to_sheets }}" >> status_report.md
        else
          echo "**Parameters:**" >> status_report.md
          echo "- Skip Existing Files: true (default for scheduled runs)" >> status_report.md
          echo "- Upload to Sheets: true (default for scheduled runs)" >> status_report.md
        fi
        
        echo "" >> status_report.md
        echo "**Results:**" >> status_report.md
        
        if [ -d "downloads" ]; then
          PDF_COUNT=$(find downloads -name "*.pdf" -type f | wc -l)
          COMPANY_COUNT=$(find downloads -type d -mindepth 1 | wc -l)
          echo "- ‚úÖ $PDF_COUNT PDF files downloaded" >> status_report.md
          echo "- ‚úÖ $COMPANY_COUNT companies processed" >> status_report.md
        else
          echo "- ‚ùå No downloads directory found" >> status_report.md
        fi
        
        if [ -d "logs" ]; then
          LOG_COUNT=$(find logs -name "*.log" -type f | wc -l)
          echo "- ‚úÖ $LOG_COUNT log files created" >> status_report.md
        else
          echo "- ‚ùå No logs directory found" >> status_report.md
        fi
        
        # Add sheets upload status
        echo "" >> status_report.md
        echo "**Google Sheets Upload:**" >> status_report.md
        if [ -n "$GOOGLE_SHEETS_CREDENTIALS" ] && [ -n "$GOOGLE_SHEET_ID" ]; then
          echo "- ‚úÖ Credentials configured" >> status_report.md
          echo "- üìä Matrix upload attempted (check logs for details)" >> status_report.md
        else
          echo "- ‚ö†Ô∏è Credentials not configured" >> status_report.md
          echo "- üìä Matrix upload skipped" >> status_report.md
        fi
        
        if ls data/mops_matrix_*.csv 1> /dev/null 2>&1; then
          CSV_COUNT=$(ls data/mops_matrix_*.csv | wc -l)
          echo "- üíæ $CSV_COUNT CSV backup files created" >> status_report.md
        else
          echo "- ‚ùå No CSV backup files found" >> status_report.md
        fi
        
        echo "" >> status_report.md
        echo "**Job Status:** ${{ job.status }}" >> status_report.md
        
        cat status_report.md